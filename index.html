<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BCI Business Capability Map</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root {
      --bg: #f5f7fa;
      --card-bg: #ffffff;
      --card-neutral: #f8fafc;
      --border: #e1e5eb;
      --border-light: #eef1f5;
      --l1-bg: #f7f9fc;
      --l1-border: #e4e9f0;
      --text-primary: #1a1a2e;
      --text-secondary: #4a5568;
      --text-light: #ffffff;
      --bci-primary: #00365B;
      --bci-secondary: #00ABBD;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      padding: 24px;
      color: var(--text-primary);
    }
    .capability-map { max-width: 1800px; margin: 0 auto; }
    .map-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid var(--bci-primary);
    }
    .map-title { font-size: 28px; font-weight: 700; color: var(--bci-primary); }
    .map-subtitle { font-size: 14px; color: var(--text-secondary); margin-top: 4px; }
    .controls-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 24px;
      margin-bottom: 20px;
      padding: 16px 20px;
      background: var(--card-bg);
      border: 1px solid var(--border);
    }
    .control-group { display: flex; align-items: center; gap: 10px; }
    .control-label { font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
    .control-select {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 13px;
      font-family: inherit;
      color: var(--text-primary);
      background: var(--card-bg);
      cursor: pointer;
      min-width: 140px;
    }
    .control-select:focus { outline: none; border-color: var(--bci-primary); }
    .toggle-container { display: flex; align-items: center; gap: 8px; }
    .toggle {
      position: relative;
      width: 44px;
      height: 24px;
      background: var(--border);
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .toggle.active { background: var(--bci-primary); }
    .toggle::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 18px;
      height: 18px;
      background: white;
      border-radius: 50%;
      transition: transform 0.2s ease;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .toggle.active::after { transform: translateX(20px); }
    .toggle-label { font-size: 13px; color: var(--text-secondary); }
    .color-controls-bar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 20px;
      margin-bottom: 16px;
      padding: 12px 16px;
      background: var(--card-bg);
      border: 1px solid var(--border);
    }
    .legend-bar {
      background: var(--card-bg);
      border: 1px solid var(--border);
      padding: 12px 16px;
      margin-bottom: 16px;
    }
    .legend-bar.hidden { display: none; }
    .legend { display: flex; align-items: center; gap: 12px; }
    .legend.hidden { display: none; }
    .legend-gradient { display: flex; align-items: center; gap: 12px; }
    .legend-gradient-bar { width: 200px; height: 16px; border-radius: 3px; }
    .legend-gradient-labels { display: flex; justify-content: space-between; width: 200px; font-size: 10px; color: var(--text-secondary); margin-top: 2px; }
    .legend-gradient-title { font-size: 11px; font-weight: 600; color: var(--text-secondary); }
    .legend-items { display: flex; gap: 12px; }
    .legend-item { display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--text-secondary); }
    .legend-color { width: 14px; height: 14px; border-radius: 3px; }
    .main-content { display: flex; gap: 20px; align-items: flex-start; }
    .sidebar { display: flex; flex-direction: column; gap: 16px; flex-shrink: 0; }
    .map-area { flex: 1; min-width: 0; }
    .filter-panel {
      background: var(--card-bg);
      border: 1px solid var(--border);
      padding: 16px;
      min-width: 180px;
      max-width: 220px;
    }
    .filter-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }
    .filter-panel-title { font-size: 12px; font-weight: 600; color: var(--text-primary); text-transform: uppercase; letter-spacing: 0.5px; }
    .filter-panel-actions { display: flex; gap: 8px; }
    .filter-panel-action { font-size: 11px; color: var(--bci-primary); cursor: pointer; text-decoration: none; }
    .filter-panel-action:hover { text-decoration: underline; }
    .filter-list { display: flex; flex-direction: column; gap: 6px; max-height: 300px; overflow-y: auto; }
    .filter-item { display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--text-primary); cursor: pointer; }
    .filter-item input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; accent-color: var(--bci-primary); }
    .filter-item label { cursor: pointer; flex: 1; }
    .domains-grid { display: flex; flex-wrap: wrap; gap: 12px; align-items: flex-start; }
    .domain-column {
      background: var(--card-bg);
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
      border: 1px solid var(--border);
      min-width: 250px;
      max-width: 400px;
      flex: 1 1 250px;
    }
    .domain-header {
      padding: 14px 16px;
      color: var(--text-light);
      font-size: 12px;
      font-weight: 600;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .domain-content { padding: 10px; }
    .l1-group {
      background: var(--l1-bg);
      border: 1px solid var(--l1-border);
      padding: 10px;
      margin-bottom: 10px;
    }
    .l1-group:last-child { margin-bottom: 0; }
    .l1-header {
      padding: 10px 12px;
      margin: -10px -10px 8px -10px;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-secondary);
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      background: #e8ecf1;
    }
    .l2-list { display: flex; flex-direction: column; gap: 5px; }
    .l2-card {
      padding: 9px 10px;
      font-size: 11px;
      font-weight: 500;
      color: var(--text-primary);
      transition: all 0.15s ease;
      cursor: pointer;
      border: 1px solid transparent;
      background: var(--card-neutral);
      position: relative;
    }
    .l2-card:hover { transform: translateY(-1px); box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1); }
    .capability-map.heatmap-off .l2-card {
      background: var(--card-bg) !important;
      border: 1px solid var(--border) !important;
      color: var(--text-primary) !important;
    }
    .capability-map.heatmap-off .l2-score { display: none; }
    .l2-card-content { display: flex; justify-content: space-between; align-items: center; gap: 8px; }
    .l2-name { flex: 1; }
    .l2-score {
      font-size: 10px;
      font-weight: 600;
      padding: 2px 6px;
      background: rgba(255,255,255,0.3);
      border-radius: 3px;
      min-width: 28px;
      text-align: center;
    }
    .capability-map.view-l1-only .l2-list { display: none; }
    .capability-map.view-l1-only .l1-header { margin-bottom: 0; }
    .capability-map.view-l1-only .l1-group { padding-bottom: 10px; }
    .capability-map.view-domain-only .domain-content { display: none; }
    .capability-map.view-domain-only .domain-header { padding: 20px 16px; }
    .export-btn {
      padding: 10px 20px;
      background: var(--bci-primary);
      color: var(--text-light);
      border: none;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      margin-left: auto;
    }
    .export-btn:hover { background: var(--bci-secondary); }
    .export-btn svg { width: 16px; height: 16px; }
    .loading { text-align: center; padding: 40px; color: var(--text-secondary); }
    .error { text-align: center; padding: 40px; color: #c0392b; }
    @media (max-width: 1000px) {
      .main-content { flex-direction: column; }
      .sidebar { flex-direction: row; flex-wrap: wrap; }
    }
    
    /* Tooltip styles */
    .l2-card[data-tooltip] { position: relative; }
    .l2-card .tooltip {
      visibility: hidden;
      position: absolute;
      z-index: 100;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: #fff;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 11px;
      white-space: nowrap;
      margin-bottom: 5px;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .l2-card:hover .tooltip {
      visibility: visible;
      opacity: 1;
    }
  </style>
</head>
<body>
  <div class="capability-map" id="capabilityMap">
    <div class="map-header">
      <div>
        <h1 class="map-title">Business Capability Map</h1>
        <p class="map-subtitle">British Columbia Investment Management Corporation (BCI) – Enterprise Architecture</p>
      </div>
    </div>
    <div class="controls-bar">
      <div class="control-group">
        <span class="control-label">View:</span>
        <select class="control-select" id="collapseSelect">
          <option value="full">Full (L1 + L2)</option>
          <option value="l1-only">L1 Only (Collapse L2s)</option>
          <option value="domain-only">Domains Only</option>
        </select>
      </div>
    </div>
    <div class="main-content">
      <div class="sidebar">
        <div class="filter-panel">
          <div class="filter-panel-header">
            <span class="filter-panel-title">Show/Hide Domains</span>
            <div class="filter-panel-actions">
              <a class="filter-panel-action" onclick="toggleAllDomains(true)">All</a>
              <a class="filter-panel-action" onclick="toggleAllDomains(false)">None</a>
            </div>
          </div>
          <div class="filter-list" id="domainCheckboxes"></div>
        </div>
        <div class="filter-panel">
          <div class="filter-panel-header">
            <span class="filter-panel-title">Show/Hide L1s</span>
            <div class="filter-panel-actions">
              <a class="filter-panel-action" onclick="toggleAllL1s(true)">All</a>
              <a class="filter-panel-action" onclick="toggleAllL1s(false)">None</a>
            </div>
          </div>
          <div class="filter-list" id="l1Checkboxes"></div>
        </div>
      </div>
      <div class="map-area">
        <div class="color-controls-bar">
          <div class="control-group">
            <span class="control-label">Color by:</span>
            <select class="control-select" id="metricSelect">
              <option value="none">None (Neutral)</option>
            </select>
          </div>
          <div class="control-group toggle-container">
            <div class="toggle active" id="heatmapToggle"></div>
            <span class="toggle-label">Show Heat Map</span>
          </div>
          <button class="export-btn" onclick="exportAsImage()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            Export as Image
          </button>
        </div>
        <div class="legend-bar" id="legendBar"></div>
        <div class="domains-grid" id="domainsGrid">
          <div class="loading">Loading capabilities...</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Configuration for heatmap overlays (BCI colors)
    const CONFIG = {
      title: "Business Capability Map",
      subtitle: "British Columbia Investment Management Corporation (BCI) – Enterprise Architecture",
      domainColors: [
        "#00365B", "#00ABBD", "#457B96", "#696F78",
        "#4A317E", "#DC642B", "#FDB736", "#C0CAAB"
      ],
      heatMapColumns: [
        {
          field: "Maturity",
          label: "Maturity",
          type: "gradient",
          min: 1, max: 5,
          colors: ["#c0392b", "#e67e22", "#f1c40f", "#7dcea0", "#27ae60"],
          labels: ["1", "2", "3", "4", "5"]
        },
        {
          field: "Risk",
          label: "Risk Score",
          type: "gradient",
          min: 1, max: 5,
          colors: ["#27ae60", "#7dcea0", "#f1c40f", "#e67e22", "#c0392b"],
          labels: ["1", "2", "3", "4", "5"]
        },
        {
          field: "TIME",
          label: "TIME Classification",
          type: "category",
          values: {
            "T": { label: "Tolerate", color: "#95a5a6" },
            "I": { label: "Invest", color: "#27ae60" },
            "M": { label: "Migrate", color: "#f39c12" },
            "E": { label: "Eliminate", color: "#c0392b" }
          }
        }
      ],
      defaultHeatMap: "Maturity"
    };

    // Global state
    let CAPABILITIES_DATA = [];
    let currentMetric = CONFIG.defaultHeatMap;
    let colorScales = {};

    // DOM references
    const capabilityMap = document.getElementById('capabilityMap');
    const metricSelect = document.getElementById('metricSelect');
    const heatmapToggle = document.getElementById('heatmapToggle');
    const collapseSelect = document.getElementById('collapseSelect');
    const domainCheckboxes = document.getElementById('domainCheckboxes');
    const l1Checkboxes = document.getElementById('l1Checkboxes');
    const domainsGrid = document.getElementById('domainsGrid');
    const legendBar = document.getElementById('legendBar');

    // Load capability data from JSON file
    async function loadCapabilities() {
      try {
        const response = await fetch('capability-map-data.json');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        CAPABILITIES_DATA = await response.json();
        return true;
      } catch (error) {
        console.error('Error loading capability data:', error);
        domainsGrid.innerHTML = `
          <div class="error">
            <h3>Failed to load capability data</h3>
            <p>Error: ${error.message}</p>
            <p>Please ensure "capability-map-data.json" is in the same directory as this HTML file.</p>
          </div>
        `;
        return false;
      }
    }

    async function init() {
      // Load data from JSON file
      const loaded = await loadCapabilities();
      if (!loaded || !CAPABILITIES_DATA.length) {
        return;
      }
      
      buildColorScales();
      populateMetricDropdown();
      buildCapabilityMap();
      setupEventListeners();
      applyColors(currentMetric);
      updateLegend(currentMetric);
    }

    function buildColorScales() {
      CONFIG.heatMapColumns.forEach(col => {
        if (col.type === 'gradient') {
          colorScales[col.field] = col.colors.map((color, i) => ({
            stop: col.min + (i * (col.max - col.min) / (col.colors.length - 1)),
            color: hexToRgb(color)
          }));
        } else if (col.type === 'category') {
          colorScales[col.field] = {};
          Object.entries(col.values).forEach(([key, val]) => {
            colorScales[col.field][key] = hexToRgb(val.color);
          });
        }
      });
    }

    function hexToRgb(hex) {
      const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return result ? [parseInt(result[1], 16), parseInt(result[2], 16), parseInt(result[3], 16)] : [128, 128, 128];
    }

    function populateMetricDropdown() {
      CONFIG.heatMapColumns.forEach(col => {
        const option = document.createElement('option');
        option.value = col.field;
        option.textContent = col.label;
        if (col.field === CONFIG.defaultHeatMap) option.selected = true;
        metricSelect.appendChild(option);
      });
    }

    function buildCapabilityMap() {
      const domains = {};
      CAPABILITIES_DATA.forEach(cap => {
        if (!domains[cap.Domain]) domains[cap.Domain] = [];
        domains[cap.Domain].push(cap);
      });

      let html = '';
      let domainIndex = 0;
      
      Object.keys(domains).sort().forEach(domainName => {
        const domainCaps = domains[domainName];
        const l1s = domainCaps.filter(c => c.Level === 1);
        const domainColor = CONFIG.domainColors[domainIndex % CONFIG.domainColors.length];
        
        html += `<div class="domain-column" data-domain-index="${domainIndex + 1}" data-domain="${domainName}">`;
        html += `<div class="domain-header" style="background: ${domainColor}">${domainName}</div>`;
        html += '<div class="domain-content">';
        
        l1s.forEach(l1 => {
          const l2s = domainCaps.filter(c => c.Level === 2 && c.Parent === l1.ID);
          
          html += '<div class="l1-group">';
          html += `<div class="l1-header">${l1.Name}</div>`;
          html += '<div class="l2-list">';
          
          l2s.forEach(l2 => {
            let dataAttrs = '';
            CONFIG.heatMapColumns.forEach(col => {
              const val = l2[col.field];
              dataAttrs += ` data-${col.field.toLowerCase()}="${val !== null && val !== undefined ? val : ''}"`;
            });
            
            // Build tooltip text
            const tooltipParts = [];
            if (l2.Maturity !== null && l2.Maturity !== undefined) {
              tooltipParts.push(`Maturity: ${l2.Maturity}`);
            }
            if (l2.Risk !== null && l2.Risk !== undefined) {
              tooltipParts.push(`Risk: ${l2.Risk}`);
            }
            if (l2.TIME) {
              const timeLabels = { T: 'Tolerate', I: 'Invest', M: 'Migrate', E: 'Eliminate' };
              tooltipParts.push(`TIME: ${timeLabels[l2.TIME] || l2.TIME}`);
            }
            const tooltipText = tooltipParts.join(' | ');
            
            html += `<div class="l2-card"${dataAttrs}>`;
            html += '<div class="l2-card-content">';
            html += `<span class="l2-name">${l2.Name}</span>`;
            html += '<span class="l2-score"></span>';
            html += '</div>';
            if (tooltipText) {
              html += `<div class="tooltip">${tooltipText}</div>`;
            }
            html += '</div>';
          });
          
          html += '</div></div>';
        });
        
        html += '</div></div>';
        domainIndex++;
      });

      domainsGrid.innerHTML = html;
      populateDomainCheckboxes();
      populateL1Checkboxes();
    }

    function updateLegend(metric) {
      if (metric === 'none' || capabilityMap.classList.contains('heatmap-off')) {
        legendBar.classList.add('hidden');
        return;
      }
      
      legendBar.classList.remove('hidden');
      const config = CONFIG.heatMapColumns.find(c => c.field === metric);
      if (!config) return;
      
      let html = '<div class="legend">';
      
      if (config.type === 'gradient') {
        html += '<div class="legend-gradient">';
        html += `<span class="legend-gradient-title">${config.label}:</span>`;
        html += '<div>';
        html += `<div class="legend-gradient-bar" style="background: linear-gradient(to right, ${config.colors.join(', ')});"></div>`;
        html += '<div class="legend-gradient-labels">';
        (config.labels || []).forEach(label => { html += `<span>${label}</span>`; });
        html += '</div></div></div>';
      } else if (config.type === 'category') {
        html += '<div class="legend-gradient">';
        html += `<span class="legend-gradient-title">${config.label}:</span>`;
        html += '<div class="legend-items">';
        Object.entries(config.values).forEach(([key, val]) => {
          html += '<div class="legend-item">';
          html += `<span class="legend-color" style="background: ${val.color}"></span>`;
          html += `${val.label}</div>`;
        });
        html += '</div></div>';
      }
      
      html += '</div>';
      legendBar.innerHTML = html;
    }

    function interpolateColor(value, scale) {
      value = Math.max(scale[0].stop, Math.min(scale[scale.length-1].stop, value));
      let lower = scale[0], upper = scale[scale.length - 1];
      for (let i = 0; i < scale.length - 1; i++) {
        if (value >= scale[i].stop && value <= scale[i + 1].stop) {
          lower = scale[i]; upper = scale[i + 1]; break;
        }
      }
      const range = upper.stop - lower.stop;
      const factor = range === 0 ? 0 : (value - lower.stop) / range;
      const r = Math.round(lower.color[0] + factor * (upper.color[0] - lower.color[0]));
      const g = Math.round(lower.color[1] + factor * (upper.color[1] - lower.color[1]));
      const b = Math.round(lower.color[2] + factor * (upper.color[2] - lower.color[2]));
      return `rgb(${r}, ${g}, ${b})`;
    }

    function getTextColor(bgColor) {
      const match = bgColor.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
      if (!match) return '#1a1a2e';
      const luminance = (0.299 * parseInt(match[1]) + 0.587 * parseInt(match[2]) + 0.114 * parseInt(match[3])) / 255;
      return luminance > 0.5 ? '#1a1a2e' : '#ffffff';
    }

    function applyColors(metric) {
      const cards = document.querySelectorAll('.l2-card');
      const config = CONFIG.heatMapColumns.find(c => c.field === metric);
      
      cards.forEach(card => {
        const scoreEl = card.querySelector('.l2-score');
        
        if (metric === 'none' || capabilityMap.classList.contains('heatmap-off')) {
          card.style.backgroundColor = ''; card.style.color = '';
          if (scoreEl) scoreEl.style.display = 'none';
          return;
        }
        
        const value = card.dataset[metric.toLowerCase()];
        if (!value || !config) {
          card.style.backgroundColor = ''; card.style.color = '';
          if (scoreEl) scoreEl.style.display = 'none';
          return;
        }
        
        if (config.type === 'category') {
          const rgb = colorScales[metric][value];
          if (rgb) {
            const bgColor = `rgb(${rgb[0]}, ${rgb[1]}, ${rgb[2]})`;
            card.style.backgroundColor = bgColor;
            card.style.color = getTextColor(bgColor);
          }
          if (scoreEl) { scoreEl.textContent = value; scoreEl.style.display = 'inline-block'; }
        } else {
          const numValue = parseFloat(value);
          if (!isNaN(numValue)) {
            const bgColor = interpolateColor(numValue, colorScales[metric]);
            card.style.backgroundColor = bgColor;
            card.style.color = getTextColor(bgColor);
            if (scoreEl) { scoreEl.textContent = numValue.toFixed(1); scoreEl.style.display = 'inline-block'; }
          }
        }
      });
    }

    function populateDomainCheckboxes() {
      const domains = document.querySelectorAll('.domain-column');
      domainCheckboxes.innerHTML = '';
      domains.forEach((domain, index) => {
        const domainName = domain.dataset.domain;
        const item = document.createElement('div');
        item.className = 'filter-item';
        item.innerHTML = `<input type="checkbox" id="domain-${index}" checked data-domain="${domainName}"><label for="domain-${index}">${domainName}</label>`;
        domainCheckboxes.appendChild(item);
        item.querySelector('input').addEventListener('change', function() { domain.style.display = this.checked ? '' : 'none'; });
      });
    }

    function populateL1Checkboxes() {
      const l1Groups = document.querySelectorAll('.l1-group');
      l1Checkboxes.innerHTML = '';
      l1Groups.forEach((l1, index) => {
        const l1Name = l1.querySelector('.l1-header').textContent;
        const item = document.createElement('div');
        item.className = 'filter-item';
        item.innerHTML = `<input type="checkbox" id="l1-${index}" checked><label for="l1-${index}">${l1Name}</label>`;
        l1Checkboxes.appendChild(item);
        item.querySelector('input').addEventListener('change', function() { l1.style.display = this.checked ? '' : 'none'; });
      });
    }

    function toggleAllDomains(show) {
      domainCheckboxes.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = show);
      document.querySelectorAll('.domain-column').forEach(d => d.style.display = show ? '' : 'none');
    }

    function toggleAllL1s(show) {
      l1Checkboxes.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = show);
      document.querySelectorAll('.l1-group').forEach(l1 => l1.style.display = show ? '' : 'none');
    }

    function setupEventListeners() {
      metricSelect.addEventListener('change', function() {
        currentMetric = this.value;
        if (currentMetric === 'none') {
          capabilityMap.classList.add('heatmap-off');
          heatmapToggle.classList.remove('active');
        } else {
          capabilityMap.classList.remove('heatmap-off');
          heatmapToggle.classList.add('active');
        }
        applyColors(currentMetric);
        updateLegend(currentMetric);
      });

      heatmapToggle.addEventListener('click', function() {
        this.classList.toggle('active');
        if (this.classList.contains('active')) {
          capabilityMap.classList.remove('heatmap-off');
          if (metricSelect.value === 'none') { metricSelect.value = CONFIG.defaultHeatMap; currentMetric = CONFIG.defaultHeatMap; }
        } else { capabilityMap.classList.add('heatmap-off'); }
        applyColors(currentMetric);
        updateLegend(currentMetric);
      });

      collapseSelect.addEventListener('change', function() {
        capabilityMap.classList.remove('view-full', 'view-l1-only', 'view-domain-only');
        if (this.value === 'l1-only') capabilityMap.classList.add('view-l1-only');
        else if (this.value === 'domain-only') capabilityMap.classList.add('view-domain-only');
      });
    }

    function exportAsImage() {
      const btn = document.querySelector('.export-btn');
      const originalText = btn.innerHTML;
      btn.innerHTML = 'Exporting...'; btn.disabled = true;
      
      if (typeof html2canvas === 'undefined') { alert('Export library not loaded.'); btn.innerHTML = originalText; btn.disabled = false; return; }
      
      html2canvas(document.getElementById('capabilityMap'), {
        backgroundColor: '#ffffff',
        scale: 2,
        useCORS: true,
        logging: false
      }).then(function(canvas) {
        const link = document.createElement('a');
        link.href = canvas.toDataURL('image/png');
        link.download = 'bci-capability-map-' + new Date().toISOString().split('T')[0] + '.png';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        btn.innerHTML = originalText;
        btn.disabled = false;
      }).catch(function(err) {
        alert('Export failed: ' + err.message);
        btn.innerHTML = originalText;
        btn.disabled = false;
      });
    }

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
